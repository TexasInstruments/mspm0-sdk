/*
 * Copyright (c) 2025, Texas Instruments Incorporated
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * *  Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 * *  Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * *  Neither the name of Texas Instruments Incorporated nor the names of
 *    its contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
 * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#include "model/tvmgen_default.h"
#include "ti_msp_dl_config.h"

/** \brief Set Macro according to desired input */
#define SAWTOOTH_WAVE

/** \brief Model input buffer for sawtooth wave */
#if defined(SAWTOOTH_WAVE)
float if_map[128] = { 
    11096.00000, 11077.00000, 8261.00000, 5673.00000, 4025.00000, 2863.00000, 
    2877.00000, 2844.00000, 2349.00000, 1902.00000, 1729.00000, 1869.00000, 
    2016.00000, 1982.00000, 1733.00000, 1505.00000, 8712.00000, 11285.00000, 
    8345.00000, 5723.00000, 3759.00000, 3065.00000, 2908.00000, 2833.00000, 
    2368.00000, 2013.00000, 1737.00000, 1762.00000, 1995.00000, 1778.00000, 
    1762.00000, 1479.00000, 11366.00000, 11468.00000, 8330.00000, 5629.00000, 
    3728.00000, 2958.00000, 3004.00000, 2746.00000, 2400.00000, 2067.00000, 
    1710.00000, 1908.00000, 2127.00000, 1890.00000, 1768.00000, 1499.00000, 
    11250.00000, 11117.00000, 8141.00000, 5738.00000, 3900.00000, 2846.00000, 
    2926.00000, 2757.00000, 2462.00000, 2166.00000, 1616.00000, 1849.00000, 
    2123.00000, 1881.00000, 1637.00000, 1720.00000, 11650.00000, 11353.00000, 
    8309.00000, 5731.00000, 3813.00000, 2839.00000, 2710.00000, 2828.00000, 
    2471.00000, 2142.00000, 1687.00000, 1787.00000, 1826.00000, 2003.00000, 
    1601.00000, 1500.00000, 11055.00000, 11675.00000, 8182.00000, 5740.00000, 
    3709.00000, 2860.00000, 3044.00000, 2702.00000, 2402.00000, 2238.00000, 
    1752.00000, 1872.00000, 2118.00000, 1905.00000, 1636.00000, 1555.00000, 
    9088.00000, 11443.00000, 8402.00000, 5595.00000, 3723.00000, 2879.00000, 
    3040.00000, 2725.00000, 2496.00000, 2050.00000, 1721.00000, 1872.00000, 
    2036.00000, 1964.00000, 1682.00000, 1464.00000, 10720.00000, 11375.00000, 
    8280.00000, 5685.00000, 3893.00000, 2734.00000, 3040.00000, 2897.00000, 
    2629.00000, 2078.00000, 1758.00000, 1741.00000, 1978.00000, 1899.00000, 
    1744.00000, 1508.00000, } ;

/** \brief Model input buffer for sine wave */
#elif defined(SINE_WAVE)
float if_map[128] = { 
    5445.00000, 968.00000, 677.00000, 571.00000, 463.00000, 366.00000, 276.00000, 
    416.00000, 429.00000, 403.00000, 411.00000, 398.00000, 332.00000, 350.00000, 
    314.00000, 343.00000, 5962.00000, 1314.00000, 942.00000, 686.00000, 465.00000, 
    466.00000, 478.00000, 416.00000, 429.00000, 448.00000, 413.00000, 433.00000, 
    392.00000, 448.00000, 328.00000, 347.00000, 7128.00000, 1624.00000, 1314.00000, 
    848.00000, 691.00000, 443.00000, 510.00000, 546.00000, 512.00000, 496.00000, 
    458.00000, 444.00000, 461.00000, 447.00000, 327.00000, 393.00000, 7221.00000, 
    1759.00000, 1190.00000, 914.00000, 794.00000, 624.00000, 590.00000, 472.00000, 
    310.00000, 474.00000, 480.00000, 424.00000, 441.00000, 544.00000, 524.00000, 
    466.00000, 6757.00000, 2088.00000, 1000.00000, 788.00000, 723.00000, 543.00000, 
    668.00000, 494.00000, 567.00000, 433.00000, 548.00000, 350.00000, 465.00000, 
    540.00000, 390.00000, 413.00000, 6753.00000, 1498.00000, 981.00000, 829.00000, 
    572.00000, 596.00000, 406.00000, 580.00000, 400.00000, 535.00000, 542.00000, 
    461.00000, 471.00000, 466.00000, 546.00000, 376.00000, 6393.00000, 1466.00000, 
    1106.00000, 771.00000, 392.00000, 448.00000, 522.00000, 420.00000, 419.00000, 
    485.00000, 520.00000, 420.00000, 387.00000, 356.00000, 400.00000, 274.00000, 
    5752.00000, 913.00000, 705.00000, 388.00000, 604.00000, 560.00000, 480.00000, 
    418.00000, 417.00000, 243.00000, 378.00000, 469.00000, 330.00000, 411.00000, 
    451.00000, 478.00000, } ;

/** \brief Model input buffer for square wave */
#elif defined(SQUARE_WAVE)
float if_map[128] = { 
    11919.00000, 10723.00000, 10627.00000, 8459.00000, 5663.00000, 4172.00000, 
    4120.00000, 3976.00000, 3958.00000, 3212.00000, 2669.00000, 2859.00000, 
    3023.00000, 2886.00000, 2789.00000, 2536.00000, 12112.00000, 11846.00000, 
    11173.00000, 8609.00000, 5741.00000, 4090.00000, 4103.00000, 4082.00000, 
    3860.00000, 3460.00000, 2872.00000, 2851.00000, 3040.00000, 3073.00000, 
    2776.00000, 2496.00000, 11181.00000, 12029.00000, 12625.00000, 8685.00000, 
    5816.00000, 4320.00000, 4213.00000, 3961.00000, 3738.00000, 3404.00000, 
    2841.00000, 2801.00000, 3096.00000, 2899.00000, 2887.00000, 2486.00000, 
    12595.00000, 10825.00000, 10991.00000, 8829.00000, 5676.00000, 3854.00000, 
    4178.00000, 4157.00000, 4048.00000, 3167.00000, 2690.00000, 2894.00000, 
    3108.00000, 3059.00000, 2694.00000, 2331.00000, 11562.00000, 13040.00000, 
    10868.00000, 8688.00000, 5856.00000, 4124.00000, 4024.00000, 4102.00000, 
    3881.00000, 3280.00000, 2715.00000, 2934.00000, 3140.00000, 3049.00000, 
    2612.00000, 2659.00000, 10967.00000, 10546.00000, 10586.00000, 9499.00000, 
    9668.00000, 8495.00000, 6408.00000, 4640.00000, 4165.00000, 4579.00000, 
    5061.00000, 4668.00000, 3652.00000, 3128.00000, 2998.00000, 2448.00000, 
    13434.00000, 13045.00000, 11909.00000, 7855.00000, 5218.00000, 4582.00000, 
    4787.00000, 4159.00000, 3472.00000, 2887.00000, 2757.00000, 2855.00000, 
    3096.00000, 2932.00000, 2748.00000, 2222.00000, 13821.00000, 13534.00000, 
    11352.00000, 7895.00000, 5388.00000, 4384.00000, 4710.00000, 4368.00000, 
    3672.00000, 3023.00000, 2588.00000, 2796.00000, 2981.00000, 3129.00000, 
    2782.00000, 2559.00000, } ;
#endif

/** \brief Index for sawtooth wave */
#define SAWTOOTH_WAVE_INDEX     (0)
/** \brief Index for sine wave */
#define SINE_WAVE_INDEX         (1)
/** \brief Index for square wave */
#define SQUARE_WAVE_INDEX       (2)

/** \brief Model output buffer for storing inference results */
float of_map[1][3]={0,0,0};

int main(void)
{
    SYSCFG_DL_init();

    /* Power up the neural processing unit (NPU) module.
     * Clear and enable the NPU interrupt.
     */
    DL_NPU_reset(NPU);
    DL_NPU_enablePower(NPU);
    while (!(DL_SYSCTL_getStatus() & DL_SYSCTL_STATUS_NPU_READY));
    DL_NPU_clearInterruptStatus(NPU, DL_NPU_INTERRUPT_DONE);
    DL_NPU_enableInterrupt(NPU, DL_NPU_INTERRUPT_DONE);
    NVIC_EnableIRQ(NPU_INT_IRQn);

    struct tvmgen_default_inputs tvm_if_map = {(void*) &if_map[0]};
    struct tvmgen_default_outputs tvm_of_map = {(void*) &of_map[0]};

    tvmgen_default_run(&tvm_if_map,&tvm_of_map);

    while(!tvmgen_default_finished);

    DL_NPU_disablePower(NPU);

    /* Based on the model output, Turn on the corresponding LED */
    uint8_t maxIndex = SAWTOOTH_WAVE_INDEX;


    if(of_map[0][SINE_WAVE_INDEX] > of_map[0][maxIndex])
    {
        maxIndex = SINE_WAVE_INDEX;
    }

    if(of_map[0][SQUARE_WAVE_INDEX] > of_map[0][maxIndex])
    {
        maxIndex = SQUARE_WAVE_INDEX;
    }


    switch(maxIndex)
    {
        case SAWTOOTH_WAVE_INDEX:
                    DL_GPIO_setPins(GPIO_LED_PORT,GPIO_LED_RED_PIN);
                    break;

        case SINE_WAVE_INDEX:
                    DL_GPIO_setPins(GPIO_LED_PORT,GPIO_LED_BLUE_PIN);
                    break;

        case SQUARE_WAVE_INDEX:
                    DL_GPIO_setPins(GPIO_LED_PORT,GPIO_LED_GREEN_PIN);
                    break;

        default:
            break;
    }


    while (1) {
        __WFI();
    }

}
